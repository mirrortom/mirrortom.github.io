<!DOCTYPE html><html lang=en><head><meta charset=utf-8 /><meta name=viewport content="width=device-width,initial-scale=1.0,user-scalable=no" /><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png /><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png /><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png /><link rel=manifest href=/site.webmanifest /><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5 /><meta name=msapplication-TileColor content=#da532c /><meta name=theme-color content=#ffffff /><title>webapi core | Mirror Space</title><link href=/mirrorui/mirrorui.css rel=stylesheet /><link href=/asset/css/blog.css rel=stylesheet /></head><body><div class=layout><div class=layout-part1></div><div class=layout-part2><div class=wz-page><p><small>2020年10月1日最后修改</small></p><p>源码 <a href=https://github.com/mirrortom/MyWebApiCore target=_blank>https://github.com/mirrortom/MyWebApiCore</a></p><div id=mytabs1 class="tabs-box list"><div class=tabs-header><span class=tabs-label>简介</span> <span class=tabs-label>实现</span> <span class=tabs-label>模板</span> <span class=tabs-label>部署</span> <span class=tabs-label>静态</span> <span class=tabs-label>示例</span> <span class=tabs-label>差别</span></div><div class="tabs-panel pd-lr-20"><h3>简介</h3><h4>使用asp.net core平台的自定义webapi项目实现.用dotnet core 控制台项目改进而来.</h4><h4>原理</h4><p>webapi程序依然是要解决三个问题.监听,匹配,处理:监听请求,分析请求地址和参数,响应请求的功能.</p><p>asp.net core监听请求使用了kestrel服务器,响应请求使用的是"中间件",与经典的asp.net管理事件相似,每个"中件间"就相当于一个处理事件.</p><p>自定义了分析地址的"中件间"UrlHandler,它分析url,然后指定具体类和方法.</p><p>自定义了异常时返回信息的"中件间"CustomExceptionHandlerOptions(),当处理发生异常时,如何返回信息.</p><h4>中间件</h4><p>中间件:"middleware",是处理请求的主要方式,是名为"RequestDelegate"的委托类型.</p><p>使用Use(middleware)添加中间件,按添加的顺序执行.</p><p>需要一个功能,就做一个中间件.也就是实现一个"RequestDelegate"委托.</p><h4>.net core 3.1</h4><p>升级到3.1框架后,跨域有变化,不允许同时指定AllowAnyOrigin和AllowCredentials,选择去掉AllowCredentials.</p><p>跨域文档地址: <a href="https://docs.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-3.1#credentials-in-cross-origin-requests" target=_blank>https://docs.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-3.1#credentials-in-cross-origin-requests</a></p><p>读取kestrel.json的库,Microsoft.Extensions.Configuration.Json,不再包含Newtonsoft.Json库,可以使用自带的System.Text.Json库,或者下载Newtonsoft.Json库</p></div><div class="tabs-panel pd-lr-20"><h3>实现</h3><h4>主要文件</h4><ul class="list num"><li>ApiHandler类: 用来写自定义的"中间件".按照定义,"中间件"是一个名为RequestDelegate的委托.</li><li>添加UrlHandler静态方法,用来分析URL,并且映射到具体的处理类上.该方法返回一个"RequestDelegate"委托.</li><li>添加一个辅助类ApiBase,提供一些便利方法.如取参数,返回结果等</li><li>[HTTPPOST][HTTPGET][HTTPALL]用于贴在方法上的特性,用于实现一些简单功能,例如区别GET或者POST.不是必要的.</li><li>kestrel.json: 自带的kestrel web服务器配置文件,配置监听端口和其它选项</li><li>Program.cs: Main()启动类,用于初始化web主机.含有一系列配置选项.</li></ul><p>kestrel配置参考这篇文章</p><a href=https://www.cnblogs.com/Leo_wl/p/7875833.html target=_blank>https://www.cnblogs.com/Leo_wl/p/7875833.html</a> <h4>一些约定</h4><p>上述工作弄好之后,就能添加API了.就是添加一个普通的类,做一些约定后就能被访问到了.</p><ul class="list num"><li>类名以Api结尾</li><li>类要继承ApiBase</li><li>类的方法上要贴上特性</li></ul></div><div class="tabs-panel pd-lr-20"><h3>建立项目</h3><ul class="list num"><li>用VS2017建一个.net core的控制台程序.添加几个重要的库:(从nuget程序包)</li><li>Microsoft.AspNetCore.Server.Kestrel // kestrel服务器</li><li>Microsoft.Extensions.Configuration.Json // 支持使用配置文件json的方式配置服务器</li><li>Microsoft.AspNetCore.Diagnostics // 发生错误时通知处理,可以自定义错误.</li><li>Microsoft.AspNetCore.Cors // 支持跨域</li><li>Microsoft.AspNetCore.Hosting.WindowsServices // 支持以windows服务方式运行web服务器(只在windows系统,不是必须)</li><li>复制文件"ApiHandler","ApiBase","kestrel.json","Program.cs(或者main()方法所在的类)"</li><li>加入一个测试类Testapi.cs,添加几个处理请求的方法.具体可以参考MyWebApiCore项目代码.</li></ul><h4>模板</h4><p>上面的项目建好后,可以导出为项目模板.以后添加新项目选择模板即可.</p></div><div class="tabs-panel pd-lr-20"><h3>部署</h3><ul class="list num"><li>可直接使用,由于自带kestrel服务器,所以能独立运行.不用部署到其它web服务器环境内</li><li>直接使用时,kestrel服务器监听来自外面的请求.但一般不会这样,因为kestrel服务器运行时,会打开一个命令行黑窗口.如果服务死掉了或者被人关掉了,需要重新打开.</li><li>可以做为反向代理.部署到IIS,Apache,nginx这些服务后面.托管asp.net core应用,可以自动重启,没有命令行黑窗口.</li><li>在windows平台,也可以托管在windows服务下,asp.net core程序支持以windows服务方式托管运行.只需要做很少的修改,这是种成本较低的部署方式.</li></ul><h4>以windows服务方式托管运行</h4><ul class="list num"><li>添加引用 Microsoft.AspNetCore.Hosting.WindowsServices</li><li>将启动语句由.Run()修改为.RunAsService()</li><li>使用sc命令建立一个windows服务:(下面MyWebApiServer是服务名字,binPath是程序路径,注意=后面有空格,另外加一个参数s,启动据此判断是从控制台启动还是服务启动.DisplayName是服务显示名字)</li><li>sc create MyWebApiServer binPath= "dotnet D:\MyWebApi\bin\Debug\netcoreapp2.1/MyWebApi.dll s" DisplayName= MyWebApiServerAspNetCore</li><li>如果建立成功了,那么打开services.msc 就能找到这个服务,然后点击启动服务.成功后,可测试调用API.</li><li>也能用sc命令启动服务: sc start MyWebApiServer</li></ul><p>注意事项:</p><ul class="list num"><li>安装服务时,如果直接将编译目录下的MyWebApi.dll当做服务程序路径,那么当编译项目时,会报错占用文件.这时在编译前需要先停止服务.</li><li>执行停止服务命令 sc stop MyWebApiServer</li></ul><p>以windows服务方式运行,具体参照这篇文章</p><a href=https://www.cnblogs.com/guogangj/p/9198031.html>https://www.cnblogs.com/guogangj/p/9198031.html</a></div><div class="tabs-panel pd-lr-20"><h3>静态文件</h3><p>需要kestrel服务器提供静态文件时,添加nuget包: Microsoft.AspNetCore.StaticFiles</p><p>静态文件参考文档: <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/static-files?view=aspnetcore-2.2#serve-static-files">https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/static-files?view=aspnetcore-2.2#serve-static-files</a></p><p>主要中间件是: UseStaticFiles(cfg) ,不带参数时,以编译输出目录下的 wwwroot 文件夹为静态文件根目录.</p><p>目录可以配置多个,就是多次调用 UseStaticFiles(cfg1).</p><h4>默认文档</h4><p>指定一个文件在网址打开时显示.例如 index.html</p><p>中间件是 UseDefaultFiles(cfg) 通过 cfg 可以指定多个默认文档.</p><h4>中间件顺序</h4><p>默认文档要在静态文件之前调用.而项目自定义的路由中间件要在最后调用,否者静态文件会找不到.</p><p>具体代码见项目Program.cs</p></div><div class="tabs-panel pd-lr-20"><h3>url示例</h3><p>这个url调用的是demo类的gethtml方法,返回html</p><p>/demo/gethtml</p><p>这个url调用的是demo1的index方法,api是demo1类的命名空间.这个功能可以将API分类(文件夹)</p><p>/api/demo1/index</p></div><div class="tabs-panel pd-lr-20"><h3>差别</h3><p>asp.net core与经典的asp.net的差别比较大了,功能上感觉更先进,处理程序设计上也改进很大</p><ul class="list num"><li>自带服务器kestrel,可以独立部署.除了windows,可部署Linux,真正跨平台.</li><li>中间件相当于管道事件,可以自由定义,而不用限制在asp.net的十几个事件点上.</li><li>系统自带了丰富的中间件,像跨域之类的.只需要配置一下就跨域了.mvc webapi这些框架也都有,习惯差不多.不过前后端分离的话,这些基本没用了.</li></ul></div></div></div><hr class=line /><br /><br /><br /><br /><br /><br /><br /><script src=/asset/js/article.js></script><script src=/mirrorui/mirrorui.js></script><script>window.ns.tabs("mytabs1")</script></div></div><script src=/asset/js/mainmenu.js></script></body></html>